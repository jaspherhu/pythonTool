功能设计文档

使用语言：python3
人机交互：tk python3
本地调用接口：串口COM

人机交互部分：
1，标题栏：串口文件传输器
2，功能栏：
    1，串口设置：波特率，COM口，校验位，数据位，停止位
    2，串口打开:按钮形式，点击后打开配置好的COM口
    3，串口关闭:按钮形式，点击后关闭配置好的COM口
    4，串口发送:按钮形式，点击后将发送栏中用户输入的字符，向着串口发送
    5，串口发送栏：文本框显示，用户向着里面写入和删除待发送的字符
    6，串口清空：按钮，点击后清空接受栏里面所有的历史数据
    7，串口数据栏：文本框显示，串口接受到的数据和用户历史发送的字符数据，格式为：时间+数据
    8，文件浏览：按钮形式，点击后弹出文件浏览窗口，用户选择文件
    9，文件路径显示栏：文本框显示，用户在文件浏览器选择的文件完整路径
    10，文件发送：按钮形式，点击后读取用户设置好的文件选择栏内的文件，使用配置好的串口持续发送，并且在使用进度条显示进度和已经花费的时间，文件发送完成后，弹框提示消息。
    11,文件接收目录配置目录配置：菜单栏中用户通过下拉选择配置该功能。
    12，配置文件：采用ini格式，记录用户配置的：文件接收路径，串口设置。
    13，文件接收：勾选方式，勾选后启动文件传输协议流程。用户取消候选后，握手帧2中的数据字段填充0x000000，拒绝接收。
    14，发件发送过程中，禁止用户打开文件浏览器选择其他文件，除非发送完成或者发送被取消。
    15，接收过程中，禁止用户点击取消接收文件的勾选按钮，除非发送完成或者发送被取消。


文件传输协议定义：
一，帧格式定义
   | 帧头(2B) | 功能码(1B) | 长度(2B) | 数据(NB) | 校验(2B) | 帧尾(1B) |
帧头：固定为0xAA 0xF5
帧尾：0x5a
长度：数据长度，包含校验位和帧头和帧尾
数据：数据内容。
校验码：校验码采用CRC16-RTU算法，计算整条报文中从枕头到数据结束所有数据的校验。
帧尾：：固定为0x5a

功能码：
        握手帧1：0x01帧 (发送方发起握手)，
        握手帧2：0x02帧 (接收方回复握手)，
        文件信息帧1：0x03帧（发送方提供待发送的文件信息）、
        文件信息帧2：0x04帧（接收方回复0x03帧信息）、
        数据帧：0x05帧（发送在确认0x04帧同意后，开始发送数据块）、
        确认帧：0x06帧（接收方回复当前进度反馈）、
        结束帧1：0x07帧（发送方告知文件发送结束）
        结束帧2：0x08帧（接收方回复0x06）
校验：报文尾部填充数据校验，采用CRC16-RTU算法（0xA001多项式）

二，每个帧的结构。例如：
握手帧1：帧头(0xaa 0xf5) + 功能码(0x01) + 长度(根据实际计算) + 数据(0xaa 0xbb 0xdd=发送文件;其他=无动作) + 校验码(根据实际计算CRC16) + 帧尾(0x5a)
握手帧2：帧头(0xaa 0xf5) + 功能码(0x02) + 长度(根据实际计算) + 数据(0xaa 0xbb 0xdd=允许文件发送;其他=拒绝) + 校验码(根据实际计算) + 帧尾(0x5a)

文件信息帧1：帧头(0xaa 0xf5) + 功能码(0x03) + 长度(根据实际计算) + 数据(文件名(32B)+文件格式(32B)+文件大小(4B)) + 校验码(根据实际计算CRC16) + 帧尾(0x5a)
文件信息帧2：帧头(0xaa 0xf5) + 功能码(0x04) + 长度(根据实际计算) + 数据(0x00=允许文件发送;~0x00=无) + 校验码(根据实际计算CRC16) + 帧尾(0x5a)

数据帧：帧头(0xaa 0xf5) + 功能码(0x05) + 长度(根据实际计算) + 数据(当前发送的是第n帧(4B)+文件数据) + 校验码(根据实际计算CRC16) + 帧尾(0x5a)
确认帧：帧头(0xaa 0xf5) + 功能码(0x06) + 长度(根据实际计算) + 数据(当前已经完成第n帧接收(4B)+当前进度百分比(2B)) + 校验码(根据实际计算CRC16) + 帧尾(0x5a)

结束帧1：帧头(0xaa 0xf5) + 功能码(0x07) + 长度(根据实际计算) + 数据(整个文件CRC16(2B)) + 校验码(根据实际计算CRC16) + 帧尾(0x5a)
结束帧2：帧头(0xaa 0xf5) + 功能码(0x07) + 长度(根据实际计算) + 数据(接收结果(2B)(0=成功/1=失败)+整个文件CRC16(2B)) + 校验码(根据实际计算CRC16) + 帧尾(0x5a)

三，文件传输流程(发送方)
1，用户点击开始发送文件后，发送方进入握手阶段1阶段。
2，发送方收到握手阶段2后，查看自己是否允许被发送，不被允许则弹窗提示接收方拒绝发送文件。被允许则进入到文件信息帧1阶段。
3，发送方以100ms频率发送此报文。如果超过10秒没有收到文件信息帧2，弹窗提示接收方确认失败。
4，发送方接收文件信息帧2之后，查看自己是否被允许发送文件，不被允许则弹窗提示接收方拒绝发送文件。被允许则进入到‘数据帧’阶段。
5，发送方持续发送此报文。如果超过10秒没有收到确认帧，弹窗提示接收方确认失败。
6，文件发送完成后，进入到结束帧1阶段。

三，文件传输流程(接收方)
1，实时检测所有接收到的数据报文
2，检测到报文为握手阶段1，参考用户选择允许接收文件，根据用户选择允许接收文件去回复握手阶段2报文。
3，检测到报文为文件信息帧1，参考用户选择允许接收文件，根据用户选择允许接收文件去回复握手阶段2报文。如果用户选择允许接收文件，则根据文件信息帧1中的文件名，在本地创建和打开文件，等待数据帧接收后往里面写入。
4，检测到报文为数据帧，则将数据帧中的数据写入文件。如果超过10秒没有收到确认帧，弹窗提示接收方确认失败。
5，检测到报文为结束帧1，按照信息帧1中的文件后缀打包文件，弹窗提示发送完成，回复结束帧2报文。

握手阶段1：发送方主动发送完整报文中的数据字段(0xAA 0xBB 0xDD)表示请求发送文件，如果没有收到握手回复2，则继续按照100ms频率持续发送‘握手阶段1’帧，如果超过10秒没有收到握手回复2帧，弹窗提示接收方握手失败。如果收到了握手回复2且被允许发送文件，则进入到‘文件信息帧1’阶段，若是握手回复2拒绝发送文件，则弹窗提示接收方拒绝发送文件。
握手阶段2：在收到握手阶段1帧之后，接收方主动回复数据字段(0xAA 0xBB 0xDD)表示接收文件就绪 ，回复一帧后进入到等待接收‘文件信息帧2’阶段。

文件信息帧1：发送方在接收到握手回复2后，以100ms频率发送此报文。如果超过10秒没有收到文件信息帧2，弹窗提示接收方确认失败。
文件信息帧2：接收方收到文件信息帧1后，回复此报文。此后进入到确认帧阶段。

数据帧：发送方在收到文件信息帧2后，以10ms频率发送此报文。如果超过10秒没有收到确认帧，弹窗提示文件发送失败。
确认帧：以1000ms频率发送此报文。如果超过5秒没有收到数据帧，弹窗提示文件发送失败。

结束帧1：发送方提示文件已经传输完成，并且填写整个文件CRC16校验码，以100ms频率发送此报文。如果超过10秒没有收到文件结束帧2，弹窗提示接收方确认失败。
结束帧2：接收方收到结束帧1后，回复此报文，并且打包文件。


    发送方                         接收方
 | -- 0xAA 0xBB 0xDD (就绪信号0x01帧) -->  | 
 | <-- 0xAA 0xBB 0xDD (确认响应0x02帧) --  | 
 | -- 文件信息帧1 0x03帧(含CRC16) ----------->  | 
 | <-- ACK(0x04帧) ------------------  | 
 | -- 数据块#1 (0x05帧)------------------->  | 
 | <-- ACK + 进度(0x06帧) --------------  | 
 | -- 数据块#N (带CRC15) ------------>  | 
 | <-- ACK + 进度100% -------------  | 
 | -- 结束帧1(0x07) ---------------->  | 
| -- 结束帧2(0x048) ---------------->  | 

[2025-03-04 15:43:56] CRC 校验: 接收到的 CRC: 1, 计算的 CRC: b'\xaa\xf5\x01\x01\x00\xaa'

[2025-03-04 15:46:29] CRC 校验: 接收到的 CRC: 2978, 计算的 CRC: b'\xaa\xf5\x01\x01\x00\xaa'
[2025-03-04 15:46:29] 创建帧: header: b'\xaa\xf5', length: b'\x01\x00', data: b'\xaa', crc: 2978, footer: b'Z'
[2025-03-04 15:46:29] 发送帧类型 0x01: 